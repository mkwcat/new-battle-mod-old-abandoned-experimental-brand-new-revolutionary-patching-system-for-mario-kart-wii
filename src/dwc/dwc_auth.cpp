EXTERN_TEXT(0x800ECA8C, void DWCi_Auth_InitInterface(int param_1));

// Wiimmfi patch. Ugly but we only do patches of entire functions.
bool sPayloadExecuted = false;

// clang-format off
// 6 parameters undocumented
REPLACE_ASM(0x800ED6E8, void DWCi_Auth_SendRequest(),
	stwu     r1, -432(r1);

	// Branching back to the original function... I don't like doing this, but
	// Wiimmfi makes patches to this function we can't ignore.
	lis      r6, sPayloadExecuted@ha;
	lbz      r0, sPayloadExecuted@l(r6);
	cmpwi    r0, 0;
	beq-     L_RunPatchedFunction;
	b        UNDEF_800ed6ec;

L_RunPatchedFunction:;
	mflr     r0;
	stw      r0, 436(r1);
	addi     r11, r1, 432;
	bl       UNDEF_8002158c;
	lwz      r6, -26820(r13);
	lis      r30, UNDEF_8027a3e8@ha;
	mr       r23, r3;
	mr       r24, r4;
	lwz      r0, 23012(r6);
	mr       r25, r5;
	mr       r27, r7;
	mr       r26, r8;
	cmpwi    r0, 3;
	addi     r30, r30, UNDEF_8027a3e8@l;
	addi     r28, r6, 20946;
	beq-     UNDEF_800ed740;
	lwz      r0, -26824(r13);
	addi     r3, r30, 140;
	slwi     r0, r0, 2;
	lwzx     r22, r3, r0;
	b        UNDEF_800ed750;
UNDEF_800ed740:;
	lwz      r0, -26824(r13);
	addi     r3, r30, 268;
	slwi     r0, r0, 2;
	lwzx     r22, r3, r0;
UNDEF_800ed750:;
	mr       r5, r22;
	addi     r4, r30, 680;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	lwz      r5, -26820(r13);
	lis      r7, UNDEF_800ee22c@ha;
	mr       r3, r22;
	li       r4, 1;
	addi     r5, r5, 16850;
	addi     r7, r7, UNDEF_800ee22c@l;
	li       r6, 4096;
	li       r8, 0;
	bl       UNDEF_801d8ff8;
	mr       r29, r3;

	// Set root CA default
	// bl       UNDEF_801d9738;

	// Set root CA to Wiimmfi CA. The set root CA function was not linked in so
	// let's just do it manually.
	bl       NHTTPi_GetSystemInfoP;
	bl       NHTTPi_GetMutexInfoP;
	mr       r4, r29;
	bl       NHTTPi_GetRequest;
	cmpwi    r3, 0;
	beq-     L_SetRootCAFail;

	lis      r4, WiimmfiCA@ha;
	addi     r0, r4, WiimmfiCA@l;
	stw      r0, 0xC0(r3);
	lis      r4, WiimmfiCA_size@ha;
	lwz      r0, WiimmfiCA_size@l(r4);
	stw      r0, 0xC4(r3);

UNDEF_800ed7ac:;
	mr       r3, r29;
	bl       UNDEF_801d9798;
	cmpwi    r3, 0;
	beq-     UNDEF_800ed7d0;
	addi     r3, r30, 692;
	addi     r5, r30, 752;
	li       r4, 923;
	crclr    6;
	bl       UNDEF_801a2660;

L_SetRootCAFail:;
	addi     r3, r30, 692;
	addi     r5, r30, 716;
	li       r4, 919;
	crclr    6;
	bl       UNDEF_801a2660;

UNDEF_800ed7d0:;
	mr       r3, r29;
	bl       UNDEF_801d9610;
	mr       r3, r29;
	// SSL_VERIFY_ROOTCA
	li       r4, 2;
	bl       UNDEF_801d9444;
	mr       r3, r29;
	addi     r4, r30, 792;
	addi     r5, r30, 804;
	bl       UNDEF_801d90d4;
	lwz      r3, -26820(r13);
	lwz      r0, 23012(r3);
	cmpwi    r0, 3;
	beq-     UNDEF_800ed820;
	lwz      r0, -26824(r13);
	addi     r3, r30, 140;
	subi     r4, r13, 31900;
	slwi     r0, r0, 2;
	lwzx     r3, r3, r0;
	bl       UNDEF_800135f0;
	b        UNDEF_800ed838;
UNDEF_800ed820:;
	lwz      r0, -26824(r13);
	addi     r3, r30, 268;
	subi     r4, r13, 31900;
	slwi     r0, r0, 2;
	lwzx     r3, r3, r0;
	bl       UNDEF_800135f0;
UNDEF_800ed838:;
	lis      r22, UNDEF_802f2038@ha;
	addi     r4, r3, 2;
	addi     r3, r22, UNDEF_802f2038@l;
	bl       UNDEF_80013120;
	addi     r3, r22, UNDEF_802f2038@l;
	subi     r4, r13, 31896;
	bl       UNDEF_800135f0;
	li       r31, 0;
	addi     r5, r22, UNDEF_802f2038@l;
	stb      r31, 0(r3);
	mr       r3, r29;
	subi     r4, r13, 31892;
	bl       UNDEF_801d90d4;
	bl       UNDEF_801a0514;
	mr       r5, r3;
	mr       r3, r29;
	addi     r4, r30, 816;
	bl       UNDEF_801d90d4;
	bl       UNDEF_801a0514;
	mr       r5, r3;
	addi     r4, r30, 832;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	cmpwi    r23, 2;
	beq-     UNDEF_800eda4c;
	bge-     UNDEF_800ed8b4;
	cmpwi    r23, 0;
	beq-     UNDEF_800ed8c0;
	bge-     UNDEF_800ed910;
	b        UNDEF_800edcd0;
UNDEF_800ed8b4:;
	cmpwi    r23, 4;
	bge-     UNDEF_800edcd0;
	b        UNDEF_800edb5c;
UNDEF_800ed8c0:;
	addi     r22, r30, 856;
	mr       r3, r22;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31884;
	bl       UNDEF_801d9198;
	addi     r4, r30, 868;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800edcd0;
UNDEF_800ed910:;
	subi     r22, r13, 31876;
	mr       r3, r22;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31884;
	bl       UNDEF_801d9198;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r25;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31868;
	bl       UNDEF_801d9198;
	addi     r4, r30, 892;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	mr       r5, r25;
	addi     r4, r30, 912;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	mr       r6, r26;
	mr       r5, r27;
	addi     r3, r1, 136;
	subi     r4, r13, 31856;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31848;
	bl       UNDEF_801d9198;
	mr       r6, r26;
	mr       r5, r27;
	addi     r4, r30, 928;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	mr       r3, r24;
	bl       UNDEF_80017998;
	slwi     r4, r3, 1;
	mr       r3, r24;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	addi     r4, r30, 952;
	bl       UNDEF_801d9198;
	b        UNDEF_800edcd0;
UNDEF_800eda4c:;
	subi     r22, r13, 31840;
	mr       r3, r22;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31884;
	bl       UNDEF_801d9198;
	addi     r4, r30, 964;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	lwz      r3, -26820(r13);
	addi     r22, r3, 16830;
	mr       r3, r22;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31832;
	bl       UNDEF_801d9198;
	lwz      r5, -26820(r13);
	addi     r4, r30, 984;
	lis      r3, 256;
	addi     r5, r5, 16830;
	crclr    6;
	bl       UNDEF_800cd068;
	mr       r6, r26;
	mr       r5, r27;
	addi     r3, r1, 136;
	subi     r4, r13, 31856;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31848;
	bl       UNDEF_801d9198;
	mr       r6, r26;
	mr       r5, r27;
	addi     r4, r30, 928;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800edcd0;
UNDEF_800edb5c:;
	lwz      r3, -26820(r13);
	lwz      r0, 16844(r3);
	cmpwi    r0, 1;
	bne-     UNDEF_800edbd4;
	mr       r6, r26;
	mr       r5, r27;
	addi     r3, r1, 136;
	subi     r4, r13, 31856;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31848;
	bl       UNDEF_801d9198;
	mr       r6, r26;
	mr       r5, r27;
	addi     r4, r30, 928;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
UNDEF_800edbd4:;
	lwz      r3, -26820(r13);
	addi     r22, r3, 16848;
	mr       r3, r22;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	li       r23, 0;
	add      r4, r3, r28;
	stbx     r23, r28, r3;
	mr       r5, r28;
	addi     r28, r4, 1;
	mr       r3, r29;
	subi     r4, r13, 31824;
	bl       UNDEF_801d9198;
	lwz      r5, -26820(r13);
	addi     r4, r30, 996;
	lis      r3, 256;
	addi     r5, r5, 16848;
	crclr    6;
	bl       UNDEF_800cd068;
	mr       r3, r29;
	subi     r4, r13, 31816;
	subi     r5, r13, 31904;
	bl       UNDEF_801d9198;
	addi     r4, r30, 1012;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	addi     r22, r30, 1024;
	mr       r3, r22;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r23, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31808;
	bl       UNDEF_801d9198;
	addi     r4, r30, 1036;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	lwz      r4, -26820(r13);
	mr       r5, r28;
	li       r6, 2048;
	lwz      r3, 16836(r4);
	lwz      r4, 16840(r4);
	bl       UNDEF_800cc7e4;
	stbx     r23, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31800;
	bl       UNDEF_801d9198;
UNDEF_800edcd0:;
	subi     r22, r13, 31792;
	mr       r3, r22;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	li       r23, 0;
	add      r4, r3, r28;
	stbx     r23, r28, r3;
	mr       r5, r28;
	addi     r28, r4, 1;
	mr       r3, r29;
	subi     r4, r13, 31784;
	bl       UNDEF_801d9198;
	bl       UNDEF_801a0514;
	mr       r22, r3;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r23, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31776;
	bl       UNDEF_801d9198;
	addi     r3, r1, 72;
	bl       UNDEF_8019e40c;
	cmpwi    r3, 0;
	bne-     UNDEF_800eddd4;
	addi     r3, r1, 72;
	addi     r4, r1, 16;
	bl       UNDEF_8019c380;
	cmpwi    r3, 0;
	bne-     UNDEF_800eddac;
	lhz      r0, 20(r1);
	cmplwi   r0, 2;
	bne-     UNDEF_800edd90;
	addi     r3, r1, 136;
	subi     r4, r13, 31768;
	li       r5, 3;
	bl       UNDEF_800131e0;
	b        UNDEF_800eddf8;
UNDEF_800edd90:;
	addi     r3, r1, 136;
	extrwi   r5, r0, 8, 16;
	clrlwi   r6, r0, 24;
	subi     r4, r13, 31764;
	crclr    6;
	bl       UNDEF_80011a2c;
	b        UNDEF_800eddf8;
UNDEF_800eddac:;
	mr       r5, r3;
	addi     r4, r30, 1056;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	addi     r3, r1, 136;
	subi     r4, r13, 31756;
	li       r5, 3;
	bl       UNDEF_800131e0;
	b        UNDEF_800eddf8;
UNDEF_800eddd4:;
	mr       r5, r3;
	addi     r4, r30, 1084;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	addi     r3, r1, 136;
	subi     r4, r13, 31756;
	li       r5, 3;
	bl       UNDEF_800131e0;
UNDEF_800eddf8:;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	li       r31, 0;
	add      r4, r3, r28;
	stbx     r31, r28, r3;
	mr       r5, r28;
	addi     r28, r4, 1;
	mr       r3, r29;
	subi     r4, r13, 31752;
	bl       UNDEF_801d9198;
	addi     r4, r30, 1116;
	addi     r5, r1, 136;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	subi     r22, r13, 31744;
	mr       r3, r22;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r3, r22;
	mr       r5, r28;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31740;
	bl       UNDEF_801d9198;
	addi     r3, r1, 24;
	bl       UNDEF_801d17f4;
	lbz      r5, 24(r1);
	addi     r3, r1, 136;
	lbz      r6, 25(r1);
	addi     r4, r30, 1132;
	lbz      r7, 26(r1);
	lbz      r8, 27(r1);
	lbz      r9, 28(r1);
	lbz      r10, 29(r1);
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31732;
	bl       UNDEF_801d9198;
	addi     r4, r30, 1160;
	addi     r5, r1, 136;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	bl       UNDEF_801b1d0c;
	clrlwi   r5, r3, 24;
	addi     r3, r1, 136;
	subi     r4, r13, 31724;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r4, r30, 1176;
	addi     r5, r1, 136;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31716;
	bl       UNDEF_801d9198;
	lwz      r3, -26820(r13);
	lwz      r0, 23012(r3);
	cmpwi    r0, 3;
	beq-     UNDEF_800ee018;
	bl       UNDEF_801aad5c;
	addi     r5, r1, 32;
	bl       UNDEF_801aafa8;
	lis      r3, 20972;
	lwz      r12, 52(r1);
	subi     r0, r3, 31457;
	lwz      r5, 48(r1);
	mulhw    r0, r0, r12;
	lwz      r7, 44(r1);
	lwz      r8, 40(r1);
	addi     r3, r1, 136;
	lwz      r9, 36(r1);
	addi     r4, r30, 1188;
	srawi    r0, r0, 5;
	lwz      r10, 32(r1);
	srwi     r11, r0, 31;
	addi     r6, r5, 1;
	add      r0, r0, r11;
	mulli    r0, r0, 100;
	sub      r5, r12, r0;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r31, r28, r3;
	add      r4, r3, r28;
	mr       r5, r28;
	mr       r3, r29;
	addi     r28, r4, 1;
	subi     r4, r13, 31704;
	bl       UNDEF_801d9198;
	addi     r4, r30, 1216;
	addi     r5, r1, 136;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
UNDEF_800ee018:;
	lwz      r3, -26820(r13);
	lbz      r0, 16416(r3);
	cmplwi   r0, 1;
	bne-     UNDEF_800ee098;
	lwz      r0, 23012(r3);
	cmpwi    r0, 3;
	beq-     UNDEF_800ee098;
	lbz      r5, 16420(r3);
	addi     r3, r1, 136;
	subi     r4, r13, 31724;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r4, r30, 1236;
	addi     r5, r1, 136;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	li       r0, 0;
	add      r4, r3, r28;
	stbx     r0, r28, r3;
	mr       r5, r28;
	addi     r28, r4, 1;
	mr       r3, r29;
	addi     r4, r30, 1256;
	bl       UNDEF_801d9198;
UNDEF_800ee098:;
	bl       UNDEF_801b2424;
	cmpwi    r3, 0;
	mr       r22, r3;
	beq-     UNDEF_800ee120;
	addi     r3, r1, 8;
	bl       UNDEF_801b2460;
	cmpwi    r3, 0;
	beq-     UNDEF_800ee120;
	lwz      r6, 8(r1);
	mr       r5, r22;
	addi     r3, r1, 136;
	subi     r4, r13, 31696;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r4, r30, 1268;
	addi     r5, r1, 136;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	li       r0, 0;
	add      r4, r3, r28;
	stbx     r0, r28, r3;
	mr       r5, r28;
	addi     r28, r4, 1;
	mr       r3, r29;
	subi     r4, r13, 31688;
	bl       UNDEF_801d9198;
UNDEF_800ee120:;
	bl       UNDEF_800e9de8;
	mr       r6, r4;
	mr       r5, r3;
	addi     r3, r1, 136;
	subi     r4, r13, 31680;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r4, r30, 1284;
	addi     r5, r1, 136;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	li       r23, 0;
	add      r4, r3, r28;
	stbx     r23, r28, r3;
	mr       r5, r28;
	addi     r28, r4, 1;
	mr       r3, r29;
	subi     r4, r13, 31672;
	bl       UNDEF_801d9198;
	lwz      r3, -26820(r13);
	lwz      r0, 23012(r3);
	cmpwi    r0, 3;
	beq-     UNDEF_800ee1f8;
	bl       UNDEF_801b23a0;
	extsb    r5, r3;
	addi     r3, r1, 136;
	subi     r4, r13, 31724;
	crclr    6;
	bl       UNDEF_80011a2c;
	addi     r4, r30, 1296;
	addi     r5, r1, 136;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	addi     r3, r1, 136;
	bl       UNDEF_80021254;
	mr       r4, r3;
	mr       r5, r28;
	addi     r3, r1, 136;
	li       r6, 2048;
	bl       UNDEF_800cc7e4;
	stbx     r23, r28, r3;
	mr       r3, r29;
	mr       r5, r28;
	subi     r4, r13, 31668;
	bl       UNDEF_801d9198;
UNDEF_800ee1f8:;
	mr       r3, r29;
	bl       UNDEF_801d925c;
	lwz      r5, -26820(r13);
	li       r0, 0;
	lis      r4, UNDEF_802f1cb8@ha;
	addi     r11, r1, 432;
	stw      r3, 23008(r5);
	stw      r0, UNDEF_802f1cb8@l(r4);
	bl       UNDEF_800215d8;
	lwz      r0, 436(r1);
	mtlr     r0;
	addi     r1, r1, 432;
	blr
)
// clang-format on

// clang-format off
REPLACE_ASM(0x800EE22C, void DWCi_Auth_HandleResponse(int param_1, int param_2),
	stwu     r1, -368(r1);
	mflr     r0;
	stw      r0, 372(r1);
	addi     r11, r1, 368;
	bl       UNDEF_80021588;
	lis      r26, UNDEF_802f1cb8@ha;
	lis      r27, UNDEF_8027a3e8@ha;
	addi     r26, r26, UNDEF_802f1cb8@l;
	mr       r21, r3;
	addi     r22, r26, 0;
	mr       r23, r4;
	lwz      r0, 456(r22);
	addi     r27, r27, UNDEF_8027a3e8@l;
	cmpwi    r0, 0;
	beq-     UNDEF_800ee280;
	addi     r4, r27, 384;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	lwz      r3, 456(r22);
	bl       UNDEF_801d92f8;
UNDEF_800ee280:;
	addi     r28, r26, 0;
	mr       r5, r21;
	stw      r23, 456(r28);
	addi     r4, r27, 1312;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	cmpwi    r21, 8;
	bne-     UNDEF_800ee2c4;
	mr       r5, r21;
	addi     r4, r27, 1336;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	li       r0, 2;
	stw      r0, 0(r26);
	b        UNDEF_800eeb54;
UNDEF_800ee2c4:;
	cmpwi    r21, 0;
	beq-     UNDEF_800ee318;
	cmpwi    r21, 14;
	bne-     UNDEF_800ee2ec;
	bl       UNDEF_801d8df0;
	mr       r5, r3;
	addi     r4, r27, 1360;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
UNDEF_800ee2ec:;
	mr       r5, r21;
	addi     r4, r27, 1376;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	li       r4, -20100;
	addi     r3, r26, 840;
	li       r0, 1;
	stw      r4, 0(r26);
	stw      r0, 52(r3);
	b        UNDEF_800eeb54;
UNDEF_800ee318:;
	mr       r3, r23;
	bl       UNDEF_801d93e4;
	cmpwi    r3, 200;
	mr       r21, r3;
	beq-     UNDEF_800ee38c;
	mr       r5, r21;
	addi     r4, r27, 1396;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	subfic   r0, r21, -23000;
	mr       r3, r23;
	stw      r0, 0(r26);
	addi     r4, r1, 16;
	bl       UNDEF_801d937c;
	cmpwi    r3, 0;
	ble-     UNDEF_800ee374;
	lwz      r5, 16(r1);
	lis      r3, 256;
	subi     r4, r13, 31660;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eeb54;
UNDEF_800ee374:;
	lwz      r5, 16(r1);
	addi     r4, r27, 1432;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eeb54;
UNDEF_800ee38c:;
	mr       r3, r23;
	addi     r4, r1, 12;
	subi     r24, r13, 31656;
	li       r23, 0;
	bl       UNDEF_801d937c;
	cmpwi    r3, 0;
	ble-     UNDEF_800eea24;

    // Patch to execute Wiimmfi payload
    // Check if we've already executed the payload
    lis      r30, sPayloadExecuted@ha;
    lbz      r0, sPayloadExecuted@l(r30);
    cmpwi    r0, 0;
    bne-     L_PayloadAlreadyExecuted;

#if 0
    lis      r3, UNDEF_80386338@ha;
    lwz      r0, UNDEF_80386338@l(r3); // DWC_AuthServer(?)
    lwz      r5, 12(r1);
    cmpwi    r0, 2;
    bne-     L_NoExecutePayload;
#endif

    lwz      r3, 12(r1);
    // Align up
    addi     r4, r3, 3;
    rlwinm   r4, r4, 0, ~3;
    lbz      r5, 0(r4);
    add      r5, r5, r4;

    // Flush the cache. Note that the official Wiimmfi patcher actually doesn't
    // bother with sync and icache (it shouldn't have previously executed code
    // at this location anyway). No reason not to be safe though.
    dcbf     0, r5;
    sync;
    icbi     0, r5;
    isync;

    mtctr    r5;
    bctrl;

    // Write that the payload was already executed
    li       r0, 1;
    stb      r0, sPayloadExecuted@l(r30);

#if 0
    b        L_PayloadAlreadyExecuted;

L_NoExecutePayload:;
    lis      r3, UNDEF_80386d4c@ha;
    lwz      r0, 12(r1);
    stw      r0, UNDEF_80386d4c@l(r3); // SSL_Initialized(?)
#endif

L_PayloadAlreadyExecuted:;
    lwz      r5, 12(r1);
	lis      r3, 256;
	subi     r4, r13, 31652;
	crclr    6;
	bl       UNDEF_800cd068;
	lwz      r3, 12(r1);
	mr       r4, r24;
	bl       UNDEF_800134cc;
	addi     r30, r1, 64;
	mr       r25, r3;
	addi     r31, r26, 464;
	li       r29, 0;
	b        UNDEF_800eea1c;
UNDEF_800ee3dc:;
	subi     r3, r13, 31644;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	subi     r4, r13, 31644;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee450;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	subi     r3, r13, 31644;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	subi     r3, r13, 31644;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r5, r3;
	mr       r6, r30;
	addi     r4, r27, 1448;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee450:;
	addi     r3, r27, 1464;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	addi     r4, r27, 1464;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee4d8;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	addi     r3, r27, 1464;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	addi     r3, r27, 1464;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r21, r3;
	mr       r4, r30;
	addi     r3, r1, 8;
	bl       UNDEF_80013120;
	mr       r5, r21;
	mr       r6, r30;
	addi     r4, r27, 1476;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	li       r23, 1;
	b        UNDEF_800eea0c;
UNDEF_800ee4d8:;
	addi     r3, r27, 1496;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	addi     r4, r27, 1496;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee5e0;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	addi     r3, r27, 1496;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	addi     r3, r27, 1496;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r21, r3;
	mr       r3, r30;
	addi     r4, r27, 1508;
	addi     r5, r1, 44;
	addi     r6, r1, 40;
	addi     r7, r1, 36;
	addi     r8, r1, 32;
	addi     r9, r1, 28;
	addi     r10, r1, 24;
	crclr    6;
	bl       UNDEF_80013040;
	cmpwi    r3, 6;
	beq-     UNDEF_800ee584;
	mr       r5, r30;
	addi     r4, r27, 1536;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	li       r25, 0;
	li       r22, 0;
	b        UNDEF_800ee5b0;
UNDEF_800ee584:;
	lwz      r4, 40(r1);
	addi     r3, r1, 24;
	stw      r29, 48(r1);
	subi     r0, r4, 1;
	stw      r0, 40(r1);
	stw      r29, 52(r1);
	stw      r29, 56(r1);
	stw      r29, 60(r1);
	bl       UNDEF_801ab170;
	mr       r25, r4;
	mr       r22, r3;
UNDEF_800ee5b0:;
	bl       UNDEF_801aad5c;
	subc     r4, r25, r4;
	mr       r5, r21;
	subfe    r0, r3, r22;
	stw      r4, 452(r28);
	addi     r4, r27, 1564;
	addi     r6, r1, 64;
	stw      r0, 448(r28);
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee5e0:;
	addi     r3, r27, 1584;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	addi     r4, r27, 1584;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee664;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	addi     r3, r27, 1584;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	addi     r3, r27, 1584;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r22, r3;
	mr       r4, r30;
	addi     r3, r28, 379;
	bl       UNDEF_80013120;
	mr       r5, r22;
	mr       r6, r30;
	addi     r4, r27, 1596;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee664:;
	subi     r3, r13, 31636;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	subi     r4, r13, 31636;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee6e8;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	subi     r3, r13, 31636;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	subi     r3, r13, 31636;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r22, r3;
	mr       r4, r30;
	addi     r3, r28, 4;
	bl       UNDEF_80013120;
	mr       r5, r22;
	mr       r6, r30;
	addi     r4, r27, 1616;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee6e8:;
	addi     r3, r27, 1632;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	addi     r4, r27, 1632;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee76c;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	addi     r3, r27, 1632;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	addi     r3, r27, 1632;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r22, r3;
	mr       r4, r30;
	addi     r3, r28, 305;
	bl       UNDEF_80013120;
	mr       r5, r22;
	mr       r6, r30;
	addi     r4, r27, 1644;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee76c:;
	subi     r3, r13, 31624;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	subi     r4, r13, 31624;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee7fc;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	subi     r3, r13, 31624;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	subi     r3, r13, 31624;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r22, r3;
	mr       r3, r30;
	addi     r5, r28, 432;
	subi     r4, r13, 31616;
	crclr    6;
	bl       UNDEF_80013040;
	lwz      r7, 432(r28);
	mr       r5, r22;
	lwz      r8, 436(r28);
	addi     r4, r27, 1664;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee7fc:;
	addi     r3, r27, 1684;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	addi     r4, r27, 1684;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee880;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	addi     r3, r27, 1684;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	addi     r3, r27, 1684;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r22, r3;
	mr       r4, r30;
	addi     r3, r31, 4;
	bl       UNDEF_80013120;
	mr       r5, r22;
	mr       r6, r30;
	addi     r4, r27, 1696;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee880:;
	addi     r3, r27, 1716;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	addi     r4, r27, 1716;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee904;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	addi     r3, r27, 1716;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	addi     r3, r27, 1716;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r22, r3;
	mr       r4, r30;
	addi     r3, r31, 69;
	bl       UNDEF_80013120;
	mr       r5, r22;
	mr       r6, r30;
	addi     r4, r27, 1732;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee904:;
	addi     r3, r27, 1756;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	addi     r4, r27, 1756;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee990;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	addi     r3, r27, 1756;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	addi     r3, r27, 1756;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r5, r3;
	mr       r6, r30;
	addi     r4, r27, 1768;
	lbz      r0, 64(r1);
	lis      r3, 256;
	extsb    r7, r0;
	subi     r0, r7, 89;
	cntlzw   r0, r0;
	srwi     r0, r0, 5;
	stw      r0, 464(r26);
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eea0c;
UNDEF_800ee990:;
	addi     r3, r27, 1792;
	bl       UNDEF_80021254;
	mr       r5, r3;
	mr       r3, r25;
	addi     r4, r27, 1792;
	bl       UNDEF_800133b8;
	cmpwi    r3, 0;
	bne-     UNDEF_800ee9f8;
	mr       r3, r25;
	bl       UNDEF_80021254;
	mr       r22, r3;
	addi     r3, r27, 1792;
	bl       UNDEF_80021254;
	sub      r22, r22, r3;
	addi     r3, r27, 1792;
	bl       UNDEF_80021254;
	mr       r4, r22;
	add      r3, r25, r3;
	addi     r5, r1, 64;
	li       r6, 256;
	bl       UNDEF_800cc974;
	stbx     r29, r30, r3;
	mr       r4, r30;
	addi     r3, r26, 840;
	bl       UNDEF_80013120;
	b        UNDEF_800eea0c;
UNDEF_800ee9f8:;
	mr       r5, r25;
	addi     r4, r27, 1804;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
UNDEF_800eea0c:;
	mr       r4, r24;
	li       r3, 0;
	bl       UNDEF_800134cc;
	mr       r25, r3;
UNDEF_800eea1c:;
	cmpwi    r25, 0;
	bne+     UNDEF_800ee3dc;
UNDEF_800eea24:;
	cmpwi    r23, 0;
	beq-     UNDEF_800eeb30;
	addi     r3, r1, 8;
	li       r4, 0;
	li       r5, 10;
	bl       UNDEF_80015350;
	cmpwi    r3, 0;
	mr       r21, r3;
	bne-     UNDEF_800eea78;
	lwz      r4, -26820(r13);
	lwz      r0, 23012(r4);
	cmpwi    r0, 3;
	beq-     UNDEF_800eea78;
	addi     r4, r27, 1828;
	addi     r5, r1, 8;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	li       r0, -20101;
	stw      r0, 0(r26);
	b        UNDEF_800eeb54;
UNDEF_800eea78:;
	cmpwi    r3, 1;
	bne-     UNDEF_800eeab4;
	lwz      r4, -26820(r13);
	lwz      r0, 23012(r4);
	cmpwi    r0, 3;
	bne-     UNDEF_800eeab4;
	addi     r4, r27, 1856;
	addi     r5, r1, 8;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	lis      r3, -1;
	addi     r0, r3, 32535;
	stw      r0, 0(r26);
	b        UNDEF_800eeb54;
UNDEF_800eeab4:;
	cmpwi    cr6, r3, 100;
	blt-     cr6, UNDEF_800eeb08;
	lwz      r3, -26820(r13);
	lwz      r0, 23012(r3);
	cmpwi    r0, 3;
	bne-     UNDEF_800eeae8;
	bne-     cr6, UNDEF_800eeae8;
	mr       r5, r21;
	addi     r4, r27, 1888;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	b        UNDEF_800eeb08;
UNDEF_800eeae8:;
	mr       r5, r21;
	addi     r4, r27, 1948;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	subfic   r0, r21, -20000;
	stw      r0, 0(r26);
	b        UNDEF_800eeb54;
UNDEF_800eeb08:;
	cmpwi    r21, 40;
	bne-     UNDEF_800eeb20;
	addi     r3, r26, 0;
	li       r0, 2;
	stw      r0, 440(r3);
	b        UNDEF_800eeb4c;
UNDEF_800eeb20:;
	addi     r3, r26, 0;
	li       r0, 1;
	stw      r0, 440(r3);
	b        UNDEF_800eeb4c;
UNDEF_800eeb30:;
	addi     r4, r27, 1976;
	lis      r3, 256;
	crclr    6;
	bl       UNDEF_800cd068;
	li       r0, -20101;
	stw      r0, 0(r26);
	b        UNDEF_800eeb54;
UNDEF_800eeb4c:;
	li       r0, 1;
	stw      r0, 0(r26);
UNDEF_800eeb54:;
	addi     r11, r1, 368;
	bl       UNDEF_800215d4;
	lwz      r0, 372(r1);
	mtlr     r0;
	addi     r1, r1, 368;
	blr
);
// clang-format on
